variables:
  DEP_FILE: "_query_list.txt"
  RES_FILE: "syntax_fast.txt"
  RES_FILE_NOFAST: "syntax_nofast.txt"
  WARN_FILE: "syntax_warnings_fast.txt"
  WARN_FILE_NOFAST: "syntax_warnings_nofast.txt"

#Pipeline runs when merge request for RoxieDev branch is created or is modified,
#except when merging from RoxieRelease-... or RoxieProd branches.
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "RoxieProd"
      when: never
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^RoxieRelease/
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "RoxieDev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^RoxieRelease/'


#Run syntax-check on the queries that allow --fastsyntax option
syntax-fast:
  stage: build
  image: gitlab.ins.risk.regn.net:4567/collda01/publicrecords/roxie-ci-clienttools

  before_script:
  script:
    - echo "Begin Query Syntax Check:"
    - cd .ci_root
    - npm install
    - eclcc --version || true
    - echo "Fetching Dependency List"
    - |
      if node get_mr_query_list.js -m -d $CI_MERGE_REQUEST_IID > $DEP_FILE
      then
      echo "Found $(cat $DEP_FILE | wc -l) Dependencies"
      querylist=$DEP_FILE
      else
      echo "Error Loading Dependencies - Default to All Services"
      querylist=
      fi
    - echo "Run Script"
    #-n option is to skip "slow" queries
    - |
      if node full_syntax_check.js -n $querylist | tee ../$RES_FILE
      then checkres=0
      else checkres=1
      fi
    - touch eclcc.log _syn_check_warnings.log
    - cat eclcc.log _syn_check_warnings.log > ../$WARN_FILE
    - exit $checkres

  artifacts:
    paths:
    - $RES_FILE
    - $WARN_FILE
    expire_in: 3 hours


#Run syntax-check on the "slow" queries (no --fastsyntax option)
syntax-nofast:
  stage: build
  image: gitlab.ins.risk.regn.net:4567/collda01/publicrecords/roxie-ci-clienttools

  before_script:
  script:
    - echo "Begin Query Syntax Check:"
    - cd .ci_root
    - npm install
    - eclcc --version || true
    - echo "Fetching Dependency List"
    - |
      if node get_mr_query_list.js -m -d $CI_MERGE_REQUEST_IID > $DEP_FILE
      then
      echo "Found $(cat $DEP_FILE | wc -l) Dependencies"
      querylist=$DEP_FILE
      else
      echo "Error Loading Dependencies - Default to All Services"
      querylist=
      fi
    - echo "Run Script"
    #-o option is to check only "slow" queries
    - |
      if node full_syntax_check.js -o $querylist | tee ../$RES_FILE_NOFAST
      then checkres=0
      else checkres=1
      fi
    - touch eclcc.log _syn_check_warnings.log
    - cat eclcc.log _syn_check_warnings.log > ../$WARN_FILE_NOFAST
    - exit $checkres

  artifacts:
    paths:
    - $RES_FILE_NOFAST
    - $WARN_FILE_NOFAST
    expire_in: 3 hours


#Combine logs from fast- and nofast-syntax
syntax-complete:
  variables:
    FRES: "res_syntax.txt"
    FWARNINGS: "res_warnings.txt"

  stage: test
  needs: [syntax-fast, syntax-nofast]

  script:
    - cat $RES_FILE $RES_FILE_NOFAST > $FRES
    - cat $WARN_FILE $WARN_FILE_NOFAST > $FWARNINGS

  artifacts:
    paths:
    - $FRES
    - $FWARNINGS
    expire_in: 4 days
